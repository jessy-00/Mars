<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼è±†åº—æ—¶é•¿è®¡ç®—å™¨ï¼ˆå•†å®¶ä¼˜åŒ–ç‰ˆï¼‰</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â±ï¸</text></svg>">
    <!-- æ–°å¢ï¼šå¼•å…¥SheetJSåº“ï¼ˆç”¨äºç”ŸæˆXLSXæ–‡ä»¶ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
        }
        
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            max-width: 100%;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .current-time {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .sync-status {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .alert-bar {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .alert-bar.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .input-section {
            padding: 15px;
            background: #f8f9fa;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s;
            min-width: 0;
        }
        
        input:focus {
            outline: none;
            border-color: #2575fc;
        }
        
        .time-input {
            max-width: 120px;
        }
        
        .package-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .package-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: #e3f2fd;
            color: #2575fc;
            border: 2px solid #2575fc;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .package-btn:active, .package-btn.active {
            background: #2575fc;
            color: white;
        }
        
        .payment-status {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .payment-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option.active {
            border-color: #2575fc;
            background: #e3f2fd;
        }
        
        .payment-option input {
            display: none;
        }
        
        .payment-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .remark-input {
            width: 100%;
            margin-bottom: 10px;
            font-size: 0.95rem;
            padding: 10px 15px;
        }
        
        .remark-input::placeholder {
            color: #999;
        }
        
        button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            white-space: nowrap;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }
        
        .btn-end {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .btn-end:active {
            box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            padding: 8px 12px;
            font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
        }
        
        .btn-delete:active {
            box-shadow: 0 2px 5px rgba(255, 152, 0, 0.3);
        }
        
        .btn-delete-all {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 10px 15px;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
            width: 100%;
            margin-top: 10px;
        }
        
        .func-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .func-btn {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #2575fc 0%, #1c68e6 100%);
        }
        
        .export-btn {
            background: linear-gradient(135deg, #9c27b0 0%, #89219e 100%);
        }
        
        .section {
            padding: 15px;
        }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title-text::before {
            content: "â€¢";
            color: #2575fc;
            font-size: 1.3rem;
        }
        
        .search-container {
            margin-bottom: 15px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            border-color: #2575fc;
            background: #e3f2fd;
            color: #2575fc;
            font-weight: 600;
        }
        
        .task-count {
            font-size: 0.9rem;
            color: #666;
            background: #f1f3f4;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .task-list {
            max-height: 35vh;
            overflow-y: auto;
        }
        
        .task-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #6a11cb;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        
        .task-item:active {
            transform: scale(0.98);
        }
        
        .seat-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-occupied {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-free {
            background: #f5f5f5;
            color: #666;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .seat-number {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .payment-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .payment-paid {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .payment-unpaid {
            background: #ffebee;
            color: #c62828;
        }
        
        .timer {
            font-size: 1.6rem;
            font-weight: bold;
            color: #2575fc;
            text-align: center;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timer.warning {
            color: #ff9800;
            animation: blink 1.5s infinite;
        }
        
        .timer.overtime {
            color: #f44336;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .planned-time {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .remark-text {
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 2px solid #2575fc;
        }
        
        .remark-text::before {
            content: "ğŸ“ å¤‡æ³¨ï¼š";
            color: #2575fc;
            font-weight: 600;
        }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }
        
        .start-time {
            font-size: 0.85rem;
            color: #666;
        }
        
        .completed-tasks {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-top: 15px;
            max-width: 100%;
        }
        
        .completed-tasks-container {
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .result-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
            position: relative;
        }
        
        .result-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        .overtime {
            color: #f44336;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .price-info {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .date-time {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px 15px;
            font-size: 0.95rem;
        }
        
        .empty-state::before {
            content: "ğŸ“";
            font-size: 1.8rem;
            display: block;
            margin-bottom: 8px;
        }
        
        .stats-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-top: 15px;
            max-width: 100%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2575fc;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .message-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 80%;
            text-align: center;
        }
        
        .message-toast.show {
            opacity: 1;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            box-shadow: none;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-form-group {
            margin-bottom: 15px;
        }
        
        .modal-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .modal-input {
            width: 100%;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        }
        
        .task-list::-webkit-scrollbar,
        .completed-tasks-container::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .task-list::-webkit-scrollbar-track,
        .completed-tasks-container::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .task-list::-webkit-scrollbar-thumb,
        .completed-tasks-container::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 3px;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .input-row {
                flex-direction: column;
            }
            
            .time-input {
                max-width: 100%;
            }
            
            .payment-status {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .task-footer {
                flex-direction: column;
                gap: 8px;
            }
            
            .task-footer button {
                width: 100%;
            }
            
            .result-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .timer {
                font-size: 1.4rem;
            }
            
            .section-title {
                font-size: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .func-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- åŸæœ‰HTMLç»“æ„ä¿æŒä¸å˜ï¼Œä»…ä¿®æ”¹å¥—é¤æŒ‰é’®éƒ¨åˆ† -->
    <div class="app-container">
        <header>
            <h1>â±ï¸ æ‹¼è±†åº—æ—¶é•¿è®¡ç®—å™¨ï¼ˆå•†å®¶ä¼˜åŒ–ç‰ˆï¼‰</h1>
            <div class="current-time" id="currentTime">--:--:--</div>
            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span id="syncStatus">æ•°æ®å·²åŒæ­¥</span>
            </div>
        </header>
        
        <div class="alert-bar" id="alertBar">
            <span id="alertMessage"></span>
        </div>
        
        <div class="input-section">
            <div class="input-row">
                <input type="text" id="seatInput" placeholder="è¯·è¾“å…¥åº§ä½å·" autocomplete="off">
                <input type="number" id="plannedMinutes" class="time-input" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿæ•°" min="1" max="480" autocomplete="off">
            </div>
            
            <!-- ä¿®æ”¹ï¼šåˆ é™¤90åˆ†é’Ÿå¥—é¤ï¼Œæ›´æ–°å…¶ä»–å¥—é¤ä»·æ ¼ -->
            <div class="package-buttons">
                <button class="package-btn" data-minutes="30">30åˆ†é’Ÿ<br>6.00å…ƒ</button>
                <button class="package-btn" data-minutes="60">60åˆ†é’Ÿ<br>11.90å…ƒ</button>
                <button class="package-btn" data-minutes="120">120åˆ†é’Ÿ<br>22.90å…ƒ</button>
            </div>
            
            <input type="text" id="remarkInput" class="remark-input" placeholder="è¾“å…¥å®¢äººå¤‡æ³¨ï¼ˆå¯é€‰ï¼Œå¦‚ï¼šéœ€è¦å¸®å¿™æ‹¼å›¾æ¡ˆï¼‰" autocomplete="off">
            
            <div class="payment-status">
                <label class="payment-option" id="paidOption">
                    <input type="radio" name="paymentStatus" value="paid" checked>
                    <span class="payment-label">
                        <span>ğŸ’° å·²æ”¯ä»˜</span>
                    </span>
                </label>
                <label class="payment-option" id="unpaidOption">
                    <input type="radio" name="paymentStatus" value="unpaid">
                    <span class="payment-label">
                        <span>ğŸ’³ æœªæ”¯ä»˜</span>
                    </span>
                </label>
            </div>
            
            <div class="func-buttons">
                <button id="startBtn">å¼€å§‹è®¡æ—¶</button>
                <button class="func-btn" id="priceSettingBtn">ä»·æ ¼è®¾ç½®</button>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">
                <span class="section-title-text">è¿›è¡Œä¸­çš„ä»»åŠ¡</span>
                <span class="task-count" id="activeTaskCount">0</span>
            </h2>
            <div class="task-list" id="activeTasks">
                <div class="empty-state">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡<br>é€‰æ‹©å¥—é¤æˆ–è¾“å…¥æ—¶é•¿å¼€å§‹æ–°ä»»åŠ¡</div>
            </div>
        </div>
    </div>
    
    <div class="completed-tasks">
        <h2 class="section-title">
            <span class="section-title-text">å·²å®Œæˆçš„ä»»åŠ¡</span>
            <span class="task-count" id="completedTaskCount">0</span>
        </h2>
        
        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢åº§ä½å·æˆ–å¤‡æ³¨...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="today">ä»Šæ—¥</button>
            <button class="filter-btn" data-filter="week">æœ¬å‘¨</button>
            <button class="filter-btn" data-filter="month">æœ¬æœˆ</button>
        </div>
        
        <div class="completed-tasks-container" id="completedTasksContainer">
            <div id="completedTasks">
                <div class="empty-state">æš‚æ— å·²å®Œæˆçš„ä»»åŠ¡</div>
            </div>
        </div>
        
        <div class="func-buttons">
            <button class="func-btn export-btn" id="exportBtn">å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨</button>
            <button class="btn-delete-all" id="deleteAllBtn">ä¸€é”®åˆ é™¤æ‰€æœ‰å·²å®Œæˆä»»åŠ¡</button>
        </div>
    </div>
    
    <div class="stats-section">
        <h2 class="section-title">
            <span class="section-title-text">ä»Šæ—¥ç»Ÿè®¡</span>
        </h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="todayTasks">0</div>
                <div class="stat-label">ä»Šæ—¥ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="todayRevenue">0</div>
                <div class="stat-label">ä»Šæ—¥æ”¶å…¥(å…ƒ)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgTime">0</div>
                <div class="stat-label">å¹³å‡ç”¨æ—¶</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="overtimeTasks">0</div>
                <div class="stat-label">è¶…æ—¶ä»»åŠ¡æ•°</div>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹ï¼šä»·æ ¼è®¾ç½®æ¨¡æ€æ¡†åˆ é™¤90åˆ†é’Ÿè¾“å…¥é¡¹ -->
    <div class="modal" id="priceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä»·æ ¼å¥—é¤è®¾ç½®</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label class="modal-label">åŸºç¡€å•ä»·ï¼ˆå…ƒ/åˆ†é’Ÿï¼‰</label>
                    <input type="number" id="basePriceInput" class="modal-input" min="0.1" step="0.01" value="0.50">
                </div>
                <div class="modal-form-group">
                    <label class="modal-label">30åˆ†é’Ÿå¥—é¤ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="pkg30Input" class="modal-input" min="0.01" step="0.01" value="6.00">
                </div>
                <div class="modal-form-group">
                    <label class="modal-label">60åˆ†é’Ÿå¥—é¤ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="pkg60Input" class="modal-input" min="0.01" step="0.01" value="11.90">
                </div>
                <div class="modal-form-group">
                    <label class="modal-label">120åˆ†é’Ÿå¥—é¤ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="pkg120Input" class="modal-input" min="0.01" step="0.01" value="22.90">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelModal">å–æ¶ˆ</button>
                <button class="modal-btn" id="savePriceBtn">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>
    
    <div class="message-toast" id="messageToast"></div>
    
    <script>
        // åŸæœ‰å˜é‡å®šä¹‰ï¼Œä¿®æ”¹PRICE_CONFIGé…ç½®
        let tasks = {};
        let completedTasks = [];
        
        // ä¿®æ”¹ï¼šæ›´æ–°ä»·æ ¼é…ç½®ï¼Œåˆ é™¤90åˆ†é’Ÿå¥—é¤ï¼Œé‡‘é¢ä¿ç•™ä¸¤ä½å°æ•°
        let PRICE_CONFIG = {
            baseRate: 0.50, // åŸºç¡€å•ä»·ä¿ç•™ä¸¤ä½å°æ•°
            packages: {
                30: 6.00,
                60: 11.90,
                120: 22.90
            }
        };
        
        let selectedPackage = null;
        
        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ‹¼è±†åº—è®¡æ—¶å™¨ï¼ˆå•†å®¶ä¼˜åŒ–ç‰ˆï¼‰åˆå§‹åŒ–ä¸­...');
            
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            loadData();
            bindEvents();
            
            setInterval(() => {
                updateAllTimers();
                checkOvertimeAlerts();
            }, 1000);
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });
        
        // åŸæœ‰bindEventså‡½æ•°ä¿æŒä¸å˜
        function bindEvents() {
            document.getElementById('startBtn').addEventListener('click', startNewTask);
            document.getElementById('deleteAllBtn').addEventListener('click', deleteAllCompletedTasks);
            document.getElementById('seatInput').addEventListener('keypress', e => e.key === 'Enter' && startNewTask());
            document.getElementById('plannedMinutes').addEventListener('keypress', e => e.key === 'Enter' && startNewTask());
            
            document.getElementById('paidOption').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('unpaidOption').classList.remove('active');
            });
            document.getElementById('unpaidOption').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('paidOption').classList.remove('active');
            });
            document.getElementById('paidOption').classList.add('active');
            
            document.querySelectorAll('.package-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.package-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedPackage = parseInt(this.dataset.minutes);
                    document.getElementById('plannedMinutes').value = selectedPackage;
                    const pkgPrice = PRICE_CONFIG.packages[selectedPackage];
                    // é‡‘é¢æ˜¾ç¤ºä¿ç•™ä¸¤ä½å°æ•°
                    showMessage(`å·²é€‰æ‹© ${selectedPackage} åˆ†é’Ÿå¥—é¤ï¼Œä»·æ ¼ ${pkgPrice.toFixed(2)} å…ƒ`, 'success');
                });
            });
            
            document.getElementById('priceSettingBtn').addEventListener('click', () => {
                document.getElementById('basePriceInput').value = PRICE_CONFIG.baseRate.toFixed(2);
                document.getElementById('pkg30Input').value = PRICE_CONFIG.packages[30].toFixed(2);
                document.getElementById('pkg60Input').value = PRICE_CONFIG.packages[60].toFixed(2);
                document.getElementById('pkg120Input').value = PRICE_CONFIG.packages[120].toFixed(2);
                document.getElementById('priceModal').classList.add('show');
            });
            
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('priceModal').classList.remove('show');
            });
            
            document.getElementById('cancelModal').addEventListener('click', () => {
                document.getElementById('priceModal').classList.remove('show');
            });
            
            document.getElementById('savePriceBtn').addEventListener('click', savePriceSettings);
            
            document.getElementById('searchInput').addEventListener('input', filterCompletedTasks);
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterCompletedTasks();
                });
            });
            
            // å¯¼å‡ºæŒ‰é’®äº‹ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
            document.getElementById('exportBtn').addEventListener('click', exportReport);
        }
        
        // åŸæœ‰å·¥å…·å‡½æ•°ä¿æŒä¸å˜ï¼Œç¡®ä¿é‡‘é¢æ˜¾ç¤ºä¿ç•™ä¸¤ä½å°æ•°
        function updateCurrentTime() {
            const now = new Date();
            const dateString = now.toLocaleDateString('zh-CN');
            const timeString = now.toLocaleTimeString('zh-CN');
            document.getElementById('currentTime').textContent = `${dateString} ${timeString}`;
        }
        
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function formatMinutes(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${mins}åˆ†é’Ÿ`;
        }
        
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // å¯¼å‡ºæŠ¥è¡¨å‡½æ•°ä¿æŒä¸å˜
        function exportReport() {
            const now = new Date();
            const reportDate = now.toLocaleDateString('zh-CN').replace(/\//g, '-');
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayTasks = completedTasks.filter(task => task.endTime >= today);
            
            // 1. å‡†å¤‡ç»Ÿè®¡æ±‡æ€»æ•°æ®
            const totalRevenue = todayTasks.reduce((sum, t) => sum + parseFloat(t.price.totalPrice), 0);
            const avgTime = todayTasks.length > 0 ? todayTasks.reduce((sum, t) => sum + t.timeElapsed, 0) / todayTasks.length : 0;
            const overtimeTasks = todayTasks.filter(t => t.overtime > 0).length;
            
            const summaryData = [
                ['æ‹¼è±†åº—ç»Ÿè®¡æŠ¥è¡¨', ''],
                ['ç»Ÿè®¡æ—¥æœŸ', reportDate],
                ['ç»Ÿè®¡æ—¶æ®µ', `${formatDateTime(today)} è‡³ ${formatDateTime(now)}`],
                ['', ''],
                ['æ€»ä½“ç»Ÿè®¡', ''],
                ['æ€»ä»»åŠ¡æ•°', todayTasks.length + ' ä¸ª'],
                ['æ€»è¥æ”¶', totalRevenue.toFixed(2) + ' å…ƒ'],
                ['å¹³å‡ç”¨æ—¶', todayTasks.length > 0 ? formatTime(avgTime) : '00:00:00'],
                ['è¶…æ—¶ä»»åŠ¡æ•°', overtimeTasks + ' ä¸ª'],
                ['', ''],
                ['ä»»åŠ¡æ˜ç»†ï¼ˆæŒ‰å®Œæˆæ—¶é—´å€’åºï¼‰', ''],
                ['', ''],
                // ä»»åŠ¡æ˜ç»†è¡¨å¤´
                [
                    'åºå·', 'åº§ä½å·', 'è®¡åˆ’æ—¶é•¿', 'å®é™…ç”¨æ—¶', 'è¶…æ—¶æƒ…å†µ', 
                    'æ”¯ä»˜çŠ¶æ€', 'è®¡åˆ’å†…ä»·æ ¼(å…ƒ)', 'è¶…æ—¶ä»·æ ¼(å…ƒ)', 'åˆè®¡ä»·æ ¼(å…ƒ)',
                    'å¤‡æ³¨', 'å¼€å§‹æ—¶é—´', 'ç»“æŸæ—¶é—´'
                ]
            ];
            
            // 2. å‡†å¤‡ä»»åŠ¡æ˜ç»†æ•°æ®
            const taskDetails = todayTasks.map((task, index) => [
                index + 1,
                task.seatNumber,
                formatMinutes(task.plannedMinutes),
                formatTime(task.timeElapsed),
                task.overtime > 0 ? formatTime(task.overtime) : 'æ— ',
                task.paymentStatus === 'paid' ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜',
                task.price.plannedPrice,
                task.price.overtimePrice,
                task.price.totalPrice,
                task.remark || 'æ— ',
                formatDateTime(task.startTime),
                formatDateTime(task.endTime)
            ]);
            
            // 3. åˆå¹¶æ‰€æœ‰æ•°æ®
            const allData = [...summaryData, ...taskDetails];
            
            // 4. åˆ›å»ºExcelå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(allData);
            
            // 5. ä¼˜åŒ–è¡¨æ ¼æ ·å¼ï¼ˆå¯é€‰ï¼‰
            // è®¾ç½®åˆ—å®½
            worksheet['!cols'] = [
                {wch: 6},  // åºå·
                {wch: 8},  // åº§ä½å·
                {wch: 12}, // è®¡åˆ’æ—¶é•¿
                {wch: 12}, // å®é™…ç”¨æ—¶
                {wch: 12}, // è¶…æ—¶æƒ…å†µ
                {wch: 10}, // æ”¯ä»˜çŠ¶æ€
                {wch: 14}, // è®¡åˆ’å†…ä»·æ ¼
                {wch: 12}, // è¶…æ—¶ä»·æ ¼
                {wch: 12}, // åˆè®¡ä»·æ ¼
                {wch: 20}, // å¤‡æ³¨
                {wch: 18}, // å¼€å§‹æ—¶é—´
                {wch: 18}  // ç»“æŸæ—¶é—´
            ];
            
            // 6. æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿å¹¶å¯¼å‡º
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ä»Šæ—¥ç»Ÿè®¡');
            XLSX.writeFile(workbook, `æ‹¼è±†åº—ç»Ÿè®¡æŠ¥è¡¨_${reportDate}.xlsx`);
            
            showMessage('Excelç»Ÿè®¡æŠ¥è¡¨å·²å¯¼å‡ºï¼', 'success');
        }
        
        // åŸæœ‰å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼Œç¡®ä¿é‡‘é¢è®¡ç®—ä¿ç•™ä¸¤ä½å°æ•°
        function startNewTask() {
            const seatInput = document.getElementById('seatInput');
            const plannedMinutesInput = document.getElementById('plannedMinutes');
            const remarkInput = document.getElementById('remarkInput');
            
            const seatNumber = seatInput.value.trim();
            let plannedMinutes = parseInt(plannedMinutesInput.value) || selectedPackage;
            const remark = remarkInput.value.trim();
            const paymentStatus = document.querySelector('input[name="paymentStatus"]:checked').value;
            
            if (!seatNumber) {
                showMessage('è¯·è¾“å…¥åº§ä½å·ï¼', 'warning');
                return;
            }
            
            if (!plannedMinutes || plannedMinutes < 1 || plannedMinutes > 480) {
                showMessage('è¯·é€‰æ‹©å¥—é¤æˆ–è¾“å…¥1-480åˆ†é’Ÿçš„æœ‰æ•ˆæ—¶é•¿ï¼', 'warning');
                return;
            }
            
            if (tasks[seatNumber]) {
                showMessage(`åº§ä½å· ${seatNumber} å·²ç»åœ¨è®¡æ—¶ä¸­ï¼`, 'warning');
                return;
            }
            
            let priceInfo = {};
            if (PRICE_CONFIG.packages[plannedMinutes]) {
                // å¥—é¤ä»·æ ¼ä¿ç•™ä¸¤ä½å°æ•°
                const pkgPrice = PRICE_CONFIG.packages[plannedMinutes];
                priceInfo = {
                    plannedPrice: pkgPrice.toFixed(2),
                    overtimePrice: '0.00',
                    overtimeMinutes: 0,
                    totalPrice: pkgPrice.toFixed(2),
                    description: `å¥—é¤ä»·ï¼ˆ${plannedMinutes}åˆ†é’Ÿï¼‰`,
                    isPackage: true
                };
            } else {
                const plannedPrice = plannedMinutes * PRICE_CONFIG.baseRate;
                priceInfo = {
                    plannedPrice: plannedPrice.toFixed(2),
                    overtimePrice: '0.00',
                    overtimeMinutes: 0,
                    totalPrice: plannedPrice.toFixed(2),
                    description: `åŸºç¡€ä»·ï¼ˆ${plannedMinutes}åˆ†é’Ÿ Ã— ${PRICE_CONFIG.baseRate.toFixed(2)}å…ƒ/åˆ†é’Ÿï¼‰`,
                    isPackage: false
                };
            }
            
            const startTime = new Date();
            tasks[seatNumber] = {
                startTime: startTime,
                plannedMinutes: plannedMinutes,
                paymentStatus: paymentStatus,
                remark: remark,
                price: priceInfo
            };
            
            seatInput.value = '';
            plannedMinutesInput.value = '';
            remarkInput.value = '';
            document.querySelectorAll('.package-btn').forEach(btn => btn.classList.remove('active'));
            selectedPackage = null;
            
            updateTasksDisplay();
            saveData();
            
            showMessage(`åº§ä½ ${seatNumber} å¼€å§‹è®¡æ—¶ï¼${remark ? 'å¤‡æ³¨ï¼š' + remark + 'ï¼Œ' : ''}${priceInfo.description}ï¼Œä»·æ ¼ ${priceInfo.totalPrice}å…ƒï¼Œæ”¯ä»˜çŠ¶æ€: ${paymentStatus === 'paid' ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}`, 'success');
        }
        
        function endTask(seatNumber) {
            if (!tasks[seatNumber]) return;
            
            const task = tasks[seatNumber];
            const endTime = new Date();
            const timeElapsed = endTime - task.startTime;
            const plannedMilliseconds = task.plannedMinutes * 60 * 1000;
            const overtime = Math.max(0, timeElapsed - plannedMilliseconds);
            const overtimeMinutes = Math.floor(overtime / 60000);
            
            let finalPriceInfo = {};
            if (task.price.isPackage) {
                const overtimePrice = overtimeMinutes * PRICE_CONFIG.baseRate;
                const totalPrice = parseFloat(task.price.plannedPrice) + overtimePrice;
                finalPriceInfo = {
                    plannedPrice: task.price.plannedPrice,
                    overtimePrice: overtimePrice.toFixed(2),
                    overtimeMinutes: overtimeMinutes,
                    totalPrice: totalPrice.toFixed(2),
                    description: task.price.description + (overtimeMinutes > 0 ? ` + è¶…æ—¶${overtimeMinutes}åˆ†é’Ÿï¼ˆåŸºç¡€ä»·ï¼‰` : '')
                };
            } else {
                const plannedPrice = task.plannedMinutes * PRICE_CONFIG.baseRate;
                const overtimePrice = overtimeMinutes * PRICE_CONFIG.baseRate;
                const totalPrice = plannedPrice + overtimePrice;
                finalPriceInfo = {
                    plannedPrice: plannedPrice.toFixed(2),
                    overtimePrice: overtimePrice.toFixed(2),
                    overtimeMinutes: overtimeMinutes,
                    totalPrice: totalPrice.toFixed(2),
                    description: `åŸºç¡€ä»·ï¼ˆè®¡åˆ’å†…${task.plannedMinutes}åˆ†é’Ÿ + è¶…æ—¶${overtimeMinutes}åˆ†é’Ÿï¼‰`
                };
            }
            
            completedTasks.unshift({
                seatNumber: seatNumber,
                startTime: new Date(task.startTime),
                endTime: endTime,
                timeElapsed: timeElapsed,
                plannedMinutes: task.plannedMinutes,
                overtime: overtime,
                paymentStatus: task.paymentStatus,
                remark: task.remark,
                price: finalPriceInfo
            });
            
            delete tasks[seatNumber];
            
            updateTasksDisplay();
            updateCompletedTasksDisplay();
            updateStatistics();
            saveData();
            
            if (overtime > 0) {
                showMessage(`åº§ä½ ${seatNumber} è®¡æ—¶å®Œæˆï¼è¶…æ—¶ ${formatTime(overtime)}ï¼Œåº”æ”¶ ${finalPriceInfo.totalPrice}å…ƒï¼ˆè®¡åˆ’å†…${finalPriceInfo.plannedPrice}å…ƒ+è¶…æ—¶${finalPriceInfo.overtimePrice}å…ƒï¼‰`, 'info');
            } else {
                showMessage(`åº§ä½ ${seatNumber} è®¡æ—¶å®Œæˆï¼æœªè¶…æ—¶ï¼Œåº”æ”¶ ${finalPriceInfo.totalPrice}å…ƒï¼ˆ${finalPriceInfo.description}ï¼‰`, 'info');
            }
        }
        
        function deleteCompletedTask(index) {
            if (index >= 0 && index < completedTasks.length) {
                const task = completedTasks[index];
                completedTasks.splice(index, 1);
                updateCompletedTasksDisplay();
                updateStatistics();
                saveData();
                showMessage(`åº§ä½ ${task.seatNumber} çš„ä»»åŠ¡å·²åˆ é™¤`, 'info');
            }
        }
        
        function deleteAllCompletedTasks() {
            if (completedTasks.length === 0) {
                showMessage('æ²¡æœ‰å¯åˆ é™¤çš„å·²å®Œæˆä»»åŠ¡', 'warning');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${completedTasks.length} ä¸ªå·²å®Œæˆä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                completedTasks = [];
                updateCompletedTasksDisplay();
                updateStatistics();
                saveData();
                showMessage('æ‰€æœ‰å·²å®Œæˆä»»åŠ¡å·²åˆ é™¤', 'info');
            }
        }
        
        function updateAllTimers() {
            const now = new Date();
            
            for (const seatNumber in tasks) {
                const task = tasks[seatNumber];
                const elapsed = now - task.startTime;
                const timerElement = document.getElementById(`timer-${seatNumber}`);
                if (!timerElement) continue;
                
                const plannedMilliseconds = task.plannedMinutes * 60 * 1000;
                const remainingTime = plannedMilliseconds - elapsed;
                
                timerElement.textContent = formatTime(elapsed);
                timerElement.classList.remove('warning', 'overtime');
                
                if (remainingTime < 0) {
                    timerElement.classList.add('overtime');
                } else if (remainingTime < 10 * 60 * 1000) {
                    timerElement.classList.add('warning');
                }
            }
        }
        
        function checkOvertimeAlerts() {
            const overtimeTasks = [];
            const now = new Date();
            
            for (const seatNumber in tasks) {
                const task = tasks[seatNumber];
                const elapsed = now - task.startTime;
                const plannedMilliseconds = task.plannedMinutes * 60 * 1000;
                if (elapsed > plannedMilliseconds) {
                    const overtimeMinutes = Math.floor((elapsed - plannedMilliseconds) / 60000);
                    overtimeTasks.push(`åº§ä½${seatNumber}ï¼ˆè¶…æ—¶${overtimeMinutes}åˆ†é’Ÿï¼‰`);
                }
            }
            
            const alertBar = document.getElementById('alertBar');
            const alertMessage = document.getElementById('alertMessage');
            
            if (overtimeTasks.length > 0) {
                alertMessage.textContent = `âš ï¸ ä»¥ä¸‹åº§ä½å·²è¶…æ—¶ï¼š${overtimeTasks.join('ã€')}ï¼Œè¯·æé†’å®¢äººï¼`;
                alertBar.classList.add('show');
            } else {
                alertBar.classList.remove('show');
            }
        }
        
        function updateTasksDisplay() {
            const activeTasksContainer = document.getElementById('activeTasks');
            const activeTaskCount = Object.keys(tasks).length;
            document.getElementById('activeTaskCount').textContent = activeTaskCount;
            
            if (activeTaskCount === 0) {
                activeTasksContainer.innerHTML = '<div class="empty-state">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡<br>é€‰æ‹©å¥—é¤æˆ–è¾“å…¥æ—¶é•¿å¼€å§‹æ–°ä»»åŠ¡</div>';
                return;
            }
            
            activeTasksContainer.innerHTML = '';
            
            for (const seatNumber in tasks) {
                const task = tasks[seatNumber];
                const elapsed = new Date() - task.startTime;
                const plannedMilliseconds = task.plannedMinutes * 60 * 1000;
                const isOvertime = elapsed > plannedMilliseconds;
                const isWarning = !isOvertime && (plannedMilliseconds - elapsed) < 10 * 60 * 1000;
                
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                
                const remarkHtml = task.remark ? `<div class="remark-text">${task.remark}</div>` : '';
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="seat-number">
                            åº§ä½ ${seatNumber}
                            <span class="seat-status status-occupied">ğŸŸ¢ å ç”¨</span>
                        </div>
                        <div class="payment-badge ${task.paymentStatus === 'paid' ? 'payment-paid' : 'payment-unpaid'}">
                            ${task.paymentStatus === 'paid' ? 'ğŸ’° å·²æ”¯ä»˜' : 'ğŸ’³ æœªæ”¯ä»˜'}
                        </div>
                    </div>
                    <div class="planned-time">è®¡åˆ’æ—¶é•¿: ${formatMinutes(task.plannedMinutes)} | ${task.price.description}</div>
                    <div class="timer ${isWarning ? 'warning' : ''} ${isOvertime ? 'overtime' : ''}" id="timer-${seatNumber}">${formatTime(elapsed)}</div>
                    ${remarkHtml}
                    <div class="date-time">å¼€å§‹æ—¶é—´: ${formatDateTime(task.startTime)}</div>
                    <div class="task-footer">
                        <button class="btn-end" onclick="endTask('${seatNumber}')">ç»“æŸè®¡æ—¶</button>
                    </div>
                `;
                
                activeTasksContainer.appendChild(taskElement);
            }
        }
        
        function updateCompletedTasksDisplay(filteredTasks = null) {
            const completedTasksContainer = document.getElementById('completedTasks');
            const tasksToShow = filteredTasks || completedTasks;
            const completedTaskCount = completedTasks.length;
            
            document.getElementById('completedTaskCount').textContent = completedTaskCount;
            
            if (tasksToShow.length === 0) {
                completedTasksContainer.innerHTML = '<div class="empty-state">æš‚æ— åŒ¹é…çš„å·²å®Œæˆä»»åŠ¡</div>';
                return;
            }
            
            completedTasksContainer.innerHTML = '';
            
            tasksToShow.forEach((task, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item';
                
                let overtimeHtml = '';
                if (task.overtime > 0) {
                    overtimeHtml = `<div class="overtime">è¶…å‡ºæ—¶é•¿: ${formatTime(task.overtime)}</div>`;
                }
                
                const remarkHtml = task.remark ? `<div class="remark-text">${task.remark}</div>` : '';
                
                let priceDetailsHtml = `
                    <div class="price-info">è®¡åˆ’å†…ä»·æ ¼: ${task.price.plannedPrice}å…ƒ</div>
                `;
                
                if (task.overtime > 0) {
                    priceDetailsHtml += `
                        <div class="price-info">è¶…æ—¶ä»·æ ¼: ${task.price.overtimePrice}å…ƒï¼ˆ${task.price.overtimeMinutes}åˆ†é’Ÿ Ã— ${PRICE_CONFIG.baseRate.toFixed(2)}å…ƒ/åˆ†é’Ÿï¼‰</div>
                        <div class="price-info">åˆè®¡ä»·æ ¼: ${task.price.totalPrice}å…ƒ</div>
                    `;
                } else {
                    priceDetailsHtml += `
                        <div class="price-info">åˆè®¡ä»·æ ¼: ${task.price.totalPrice}å…ƒï¼ˆæ— è¶…æ—¶ï¼‰</div>
                    `;
                }
                
                resultElement.innerHTML = `
                    <div class="result-header">
                        <div>
                            <span>åº§ä½ ${task.seatNumber}</span>
                            <span class="seat-status status-free">â¹ï¸ ç©ºé—²</span>
                            <span class="payment-badge ${task.paymentStatus === 'paid' ? 'payment-paid' : 'payment-unpaid'}">
                                ${task.paymentStatus === 'paid' ? 'ğŸ’° å·²æ”¯ä»˜' : 'ğŸ’³ æœªæ”¯ä»˜'}
                            </span>
                        </div>
                        <button class="btn-delete" onclick="deleteCompletedTask(${index})">åˆ é™¤</button>
                    </div>
                    <div class="result-details">
                        è®¡åˆ’æ—¶é•¿: ${formatMinutes(task.plannedMinutes)}<br>
                        å¼€å§‹: ${formatDateTime(task.startTime)}<br>
                        ç»“æŸ: ${formatDateTime(task.endTime)}<br>
                        ç”¨æ—¶: ${formatTime(task.timeElapsed)}
                        ${overtimeHtml}
                        ${remarkHtml}
                        ${priceDetailsHtml}
                        <div class="price-info">è®¡è´¹è¯´æ˜: ${task.price.description}</div>
                    </div>
                `;
                
                completedTasksContainer.appendChild(resultElement);
            });
        }
        
        function filterCompletedTasks() {
            const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let filteredTasks = completedTasks.filter(task => {
                const matchesSearch = 
                    task.seatNumber.toLowerCase().includes(searchText) || 
                    (task.remark && task.remark.toLowerCase().includes(searchText));
                
                let matchesTime = true;
                if (activeFilter === 'today') {
                    matchesTime = task.endTime >= today;
                } else if (activeFilter === 'week') {
                    matchesTime = task.endTime >= weekStart;
                } else if (activeFilter === 'month') {
                    matchesTime = task.endTime >= monthStart;
                }
                
                return matchesSearch && matchesTime;
            });
            
            updateCompletedTasksDisplay(filteredTasks);
        }
        
        function updateStatistics() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayTasks = completedTasks.filter(task => task.endTime >= today);
            const totalRevenue = todayTasks.reduce((sum, task) => sum + parseFloat(task.price.totalPrice), 0);
            const avgTime = todayTasks.length > 0 ? todayTasks.reduce((sum, task) => sum + task.timeElapsed, 0) / todayTasks.length : 0;
            const overtimeTasks = todayTasks.filter(task => task.overtime > 0).length;
            
            document.getElementById('todayTasks').textContent = todayTasks.length;
            document.getElementById('todayRevenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('avgTime').textContent = formatTime(avgTime);
            document.getElementById('overtimeTasks').textContent = overtimeTasks;
        }
        
        function savePriceSettings() {
            const baseRate = parseFloat(document.getElementById('basePriceInput').value);
            const pkg30 = parseFloat(document.getElementById('pkg30Input').value);
            const pkg60 = parseFloat(document.getElementById('pkg60Input').value);
            const pkg120 = parseFloat(document.getElementById('pkg120Input').value);
            
            if (isNaN(baseRate) || baseRate <= 0) {
                showMessage('åŸºç¡€å•ä»·å¿…é¡»å¤§äº0ï¼', 'warning');
                return;
            }
            
            if ([pkg30, pkg60, pkg120].some(p => isNaN(p) || p <= 0)) {
                showMessage('å¥—é¤ä»·æ ¼å¿…é¡»å¤§äº0ï¼', 'warning');
                return;
            }
            
            // ä¿å­˜æ—¶ç¡®ä¿é‡‘é¢ä¿ç•™ä¸¤ä½å°æ•°
            PRICE_CONFIG = {
                baseRate: parseFloat(baseRate.toFixed(2)),
                packages: {
                    30: parseFloat(pkg30.toFixed(2)),
                    60: parseFloat(pkg60.toFixed(2)),
                    120: parseFloat(pkg120.toFixed(2))
                }
            };
            
            // æ›´æ–°å¥—é¤æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿é‡‘é¢ä¸¤ä½å°æ•°
            document.querySelectorAll('.package-btn').forEach(btn => {
                const minutes = btn.dataset.minutes;
                const price = PRICE_CONFIG.packages[minutes].toFixed(2);
                btn.innerHTML = `${minutes}åˆ†é’Ÿ<br>${price}å…ƒ`;
            });
            
            saveData();
            document.getElementById('priceModal').classList.remove('show');
            showMessage('ä»·æ ¼è®¾ç½®å·²ä¿å­˜ï¼', 'success');
        }
        
        function showMessage(message, type = 'info') {
            const toast = document.getElementById('messageToast');
            toast.textContent = message;
            
            if (type === 'warning') {
                toast.style.background = 'rgba(244, 67, 54, 0.9)';
            } else if (type === 'success') {
                toast.style.background = 'rgba(76, 175, 80, 0.9)';
            } else {
                toast.style.background = 'rgba(0, 0, 0, 0.8)';
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function saveData() {
            try {
                const data = {
                    tasks: {},
                    completedTasks: completedTasks.map(task => ({
                        ...task,
                        startTime: task.startTime.getTime(),
                        endTime: task.endTime.getTime()
                    })),
                    priceConfig: PRICE_CONFIG
                };
                
                for (const seatNumber in tasks) {
                    data.tasks[seatNumber] = {
                        startTime: tasks[seatNumber].startTime.getTime(),
                        plannedMinutes: tasks[seatNumber].plannedMinutes,
                        paymentStatus: tasks[seatNumber].paymentStatus,
                        remark: tasks[seatNumber].remark,
                        price: tasks[seatNumber].price
                    };
                }
                
                localStorage.setItem('timeTrackerData', JSON.stringify(data));
                updateSyncStatus('æ•°æ®å·²ä¿å­˜', '#4CAF50');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('ä¿å­˜å¤±è´¥', '#f44336');
            }
        }
        
        function loadData() {
            try {
                const savedData = localStorage.getItem('timeTrackerData');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.priceConfig) {
                        // åŠ è½½æ—¶ç¡®ä¿é‡‘é¢ä¿ç•™ä¸¤ä½å°æ•°
                        PRICE_CONFIG = {
                            baseRate: parseFloat(data.priceConfig.baseRate.toFixed(2)),
                            packages: {
                                30: parseFloat((data.priceConfig.packages[30] || 6.00).toFixed(2)),
                                60: parseFloat((data.priceConfig.packages[60] || 11.90).toFixed(2)),
                                120: parseFloat((data.priceConfig.packages[120] || 22.90).toFixed(2))
                            }
                        };
                    } else {
                        PRICE_CONFIG = {
                            baseRate: 0.50,
                            packages: { 30:6.00, 60:11.90, 120:22.90 }
                        };
                    }
                    
                    // æ›´æ–°å¥—é¤æŒ‰é’®æ˜¾ç¤º
                    document.querySelectorAll('.package-btn').forEach(btn => {
                        const minutes = btn.dataset.minutes;
                        const price = PRICE_CONFIG.packages[minutes].toFixed(2);
                        btn.innerHTML = `${minutes}åˆ†é’Ÿ<br>${price}å…ƒ`;
                    });
                    
                    tasks = {};
                    for (const seatNumber in data.tasks) {
                        tasks[seatNumber] = {
                            startTime: new Date(data.tasks[seatNumber].startTime),
                            plannedMinutes: data.tasks[seatNumber].plannedMinutes,
                            paymentStatus: data.tasks[seatNumber].paymentStatus || 'unpaid',
                            remark: data.tasks[seatNumber].remark || '',
                            price: data.tasks[seatNumber].price || {
                                plannedPrice: (data.tasks[seatNumber].plannedMinutes * PRICE_CONFIG.baseRate).toFixed(2),
                                overtimePrice: '0.00',
                                overtimeMinutes: 0,
                                totalPrice: (data.tasks[seatNumber].plannedMinutes * PRICE_CONFIG.baseRate).toFixed(2),
                                description: 'åŸºç¡€ä»·',
                                isPackage: false
                            }
                        };
                    }
                    
                    if (data.completedTasks) {
                        completedTasks = data.completedTasks.map(task => {
                            const overtimeMinutes = Math.floor((task.overtime || 0) / 60000);
                            let priceInfo = task.price || {};
                            
                            if (!priceInfo.plannedPrice) {
                                if (PRICE_CONFIG.packages[task.plannedMinutes]) {
                                    const plannedPrice = PRICE_CONFIG.packages[task.plannedMinutes];
                                    const overtimePrice = overtimeMinutes * PRICE_CONFIG.baseRate;
                                    priceInfo = {
                                        plannedPrice: plannedPrice.toFixed(2),
                                        overtimePrice: overtimePrice.toFixed(2),
                                        overtimeMinutes: overtimeMinutes,
                                        totalPrice: (plannedPrice + overtimePrice).toFixed(2),
                                        description: `å¥—é¤ä»·ï¼ˆ${task.plannedMinutes}åˆ†é’Ÿï¼‰`
                                    };
                                } else {
                                    const plannedPrice = task.plannedMinutes * PRICE_CONFIG.baseRate;
                                    const overtimePrice = overtimeMinutes * PRICE_CONFIG.baseRate;
                                    priceInfo = {
                                        plannedPrice: plannedPrice.toFixed(2),
                                        overtimePrice: overtimePrice.toFixed(2),
                                        overtimeMinutes: overtimeMinutes,
                                        totalPrice: (plannedPrice + overtimePrice).toFixed(2),
                                        description: `åŸºç¡€ä»·ï¼ˆ${task.plannedMinutes}åˆ†é’Ÿï¼‰`
                                    };
                                }
                            }
                            
                            return {
                                seatNumber: task.seatNumber,
                                startTime: new Date(task.startTime),
                                endTime: new Date(task.endTime),
                                timeElapsed: task.timeElapsed,
                                plannedMinutes: task.plannedMinutes,
                                overtime: task.overtime || 0,
                                paymentStatus: task.paymentStatus || 'unpaid',
                                remark: task.remark || '',
                                price: priceInfo
                            };
                        });
                    }
                    
                    updateTasksDisplay();
                    updateCompletedTasksDisplay();
                    updateStatistics();
                    updateSyncStatus('æ•°æ®å·²åŠ è½½', '#4CAF50');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('åŠ è½½å¤±è´¥', '#f44336');
            }
        }
        
        function updateSyncStatus(message, color) {
            const syncStatus = document.getElementById('syncStatus');
            const syncIndicator = document.querySelector('.sync-indicator');
            syncStatus.textContent = message;
            syncIndicator.style.backgroundColor = color;
        }
        
        window.endTask = endTask;
        window.deleteCompletedTask = deleteCompletedTask;
    </script>
</body>
</html>